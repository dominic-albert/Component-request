<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Component Request System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 1.4;
      color: #333;
      background: #fff;
      overflow-x: hidden;
    }

    .container {
      padding: 16px;
      max-width: 100%;
    }

    .header {
      margin-bottom: 16px;
      text-align: center;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #000;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 11px;
      color: #666;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
      background: #fff;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #18a0fb;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      display: flex;
      gap: 8px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .button {
      width: 100%;
      padding: 10px 16px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .button:hover {
      background: #0d8ce8;
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button.secondary:hover {
      background: #e0e0e0;
    }

    .selection-info {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .selection-info h3 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }

    .selection-info p {
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }

    .error {
      background: #fff2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 12px;
    }

    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 12px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      color: #666;
      font-size: 11px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #18a0fb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    .api-setup {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .api-setup h3 {
      font-size: 12px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }

    .api-setup p {
      font-size: 11px;
      color: #92400e;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Component Request</h1>
      <p>Create requests from selected frames or components</p>
    </div>

    <!-- API Setup Section -->
    <div id="apiSetup" class="api-setup">
      <h3>Setup Required</h3>
      <p>Enter your dashboard API details to get started:</p>
      
      <div class="form-group">
        <label for="apiEndpoint">Dashboard API Endpoint *</label>
        <input type="url" id="apiEndpoint" placeholder="https://your-dashboard.com/api/requests" required>
      </div>
      
      <div class="form-group">
        <label for="apiKey">API Key *</label>
        <input type="password" id="apiKey" placeholder="Enter your API key" required>
      </div>
      
      <button class="button" onclick="saveApiSettings()">Save Settings</button>
    </div>

    <!-- Main Form -->
    <div id="mainForm" class="hidden">
      <!-- Error/Success Messages -->
      <div id="errorMessage" class="error hidden"></div>
      <div id="successMessage" class="success hidden"></div>

      <!-- Selection Info -->
      <div id="selectionInfo" class="selection-info hidden">
        <h3>Selected Element</h3>
        <p id="selectionName"></p>
        <p id="selectionType"></p>
        <p id="selectionDimensions"></p>
      </div>

      <!-- Form Fields -->
      <div class="form-row">
        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required>
            <option value="">Select category</option>
            <option value="Form">Form</option>
            <option value="Navigation">Navigation</option>
            <option value="Display">Display</option>
            <option value="Input">Input</option>
            <option value="Layout">Layout</option>
          </select>
        </div>
        <div class="form-group">
          <label for="priority">Priority *</label>
          <select id="priority" required>
            <option value="">Select priority</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Urgent">Urgent</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="componentName">Component Name *</label>
        <input type="text" id="componentName" placeholder="e.g., Advanced Data Table" required>
      </div>

      <div class="form-group">
        <label for="requesterName">Your Name *</label>
        <input type="text" id="requesterName" placeholder="Your full name" required>
      </div>

      <div class="form-group">
        <label for="requesterEmail">Your Email *</label>
        <input type="email" id="requesterEmail" placeholder="your.email@company.com" required>
      </div>

      <div class="form-group">
        <label for="description">Description *</label>
        <textarea id="description" placeholder="Describe the component requirements, use cases, and specific features needed..." required></textarea>
      </div>

      <!-- Action Buttons -->
      <div id="actionButtons">
        <button class="button" onclick="createRequest()" id="createButton">
          Create Request
        </button>
        <button class="button secondary" onclick="clearForm()" style="margin-top: 8px;">
          Clear Form
        </button>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="loading hidden">
        <div class="spinner"></div>
        <span>Creating request...</span>
      </div>
    </div>
  </div>

  <script>
    // Plugin UI JavaScript - Clean implementation
    const pluginUI = {
      currentSelection: null,
      currentFigmaLink: null,
      apiSettings: null,

      init() {
        this.setupEventListeners()
        this.loadApiSettings()
        this.requestSelectionUpdate()
      },

      setupEventListeners() {
        // Listen for messages from plugin code
        window.addEventListener('message', (event) => {
          this.handlePluginMessage(event.data.pluginMessage)
        })
      },

      loadApiSettings() {
        // Try to load from session storage (more reliable than localStorage in plugins)
        try {
          const saved = sessionStorage.getItem('componentRequestApiSettings')
          if (saved) {
            this.apiSettings = JSON.parse(saved)
            document.getElementById('apiEndpoint').value = this.apiSettings.endpoint || ''
            document.getElementById('apiKey').value = this.apiSettings.key || ''
            
            if (this.apiSettings.endpoint && this.apiSettings.key) {
              this.showMainForm()
            }
          }
        } catch (error) {
          // Session storage might not be available, that's okay
          console.log('Could not load saved settings:', error)
        }
      },

      saveApiSettings() {
        const endpoint = document.getElementById('apiEndpoint').value.trim()
        const key = document.getElementById('apiKey').value.trim()
        
        if (!endpoint || !key) {
          this.showError('Please enter both API endpoint and API key')
          return
        }
        
        // Validate URL format
        try {
          new URL(endpoint)
        } catch (error) {
          this.showError('Please enter a valid API endpoint URL')
          return
        }
        
        this.apiSettings = { endpoint, key }
        
        try {
          sessionStorage.setItem('componentRequestApiSettings', JSON.stringify(this.apiSettings))
        } catch (error) {
          console.log('Could not save settings:', error)
        }
        
        this.showMainForm()
      },

      showMainForm() {
        document.getElementById('apiSetup').classList.add('hidden')
        document.getElementById('mainForm').classList.remove('hidden')
      },

      requestSelectionUpdate() {
        this.sendToPlugin({ type: 'get-selection' })
      },

      sendToPlugin(message) {
        parent.postMessage({ pluginMessage: message }, '*')
      },

      handlePluginMessage(message) {
        if (!message) return

        const { type, data, link, error } = message

        switch (type) {
          case 'selection-updated':
            this.updateSelectionInfo(data, link, error)
            break
            
          case 'request-success':
            this.handleRequestSuccess(data)
            break
            
          case 'request-error':
            this.handleRequestError(error)
            break
        }
      },

      updateSelectionInfo(selection, link, error) {
        const infoEl = document.getElementById('selectionInfo')
        
        this.hideMessages()
        
        if (error) {
          this.showError(error)
          infoEl.classList.add('hidden')
          this.currentSelection = null
          this.currentFigmaLink = null
        } else if (selection && selection.length > 0) {
          const item = selection[0]
          document.getElementById('selectionName').textContent = `Name: ${item.name}`
          document.getElementById('selectionType').textContent = `Type: ${item.type}`
          document.getElementById('selectionDimensions').textContent = `Size: ${Math.round(item.width)} × ${Math.round(item.height)}px`
          
          // Pre-fill component name if empty
          const nameInput = document.getElementById('componentName')
          if (!nameInput.value) {
            nameInput.value = item.name
          }
          
          infoEl.classList.remove('hidden')
          this.currentSelection = item
          this.currentFigmaLink = link
        } else {
          infoEl.classList.add('hidden')
          this.currentSelection = null
          this.currentFigmaLink = null
        }

        this.checkFormValidity()
      },

      handleRequestSuccess(data) {
        this.resetLoadingState()
        this.showSuccess(`Request created successfully! ID: ${data.id || 'Unknown'}`)
        this.clearForm()
      },

      handleRequestError(error) {
        this.resetLoadingState()
        this.showError(`Failed to create request: ${error}`)
      },

      showError(message) {
        const errorEl = document.getElementById('errorMessage')
        errorEl.textContent = message
        errorEl.classList.remove('hidden')
        document.getElementById('successMessage').classList.add('hidden')
      },

      showSuccess(message) {
        const successEl = document.getElementById('successMessage')
        successEl.textContent = message
        successEl.classList.remove('hidden')
        document.getElementById('errorMessage').classList.add('hidden')
      },

      hideMessages() {
        document.getElementById('errorMessage').classList.add('hidden')
        document.getElementById('successMessage').classList.add('hidden')
      },

      checkFormValidity() {
        const apiValid = this.apiSettings && this.apiSettings.endpoint && this.apiSettings.key
        const category = document.getElementById('category').value
        const priority = document.getElementById('priority').value
        const componentName = document.getElementById('componentName').value.trim()
        const requesterName = document.getElementById('requesterName').value.trim()
        const requesterEmail = document.getElementById('requesterEmail').value.trim()
        const description = document.getElementById('description').value.trim()

        const isFormValid = apiValid && category && priority && componentName && 
                           requesterName && requesterEmail && description && 
                           this.currentSelection

        document.getElementById('createButton').disabled = !isFormValid
      },

      createRequest() {
        this.hideMessages()
        
        if (!this.apiSettings || !this.apiSettings.endpoint || !this.apiSettings.key) {
          this.showError('API settings are required. Please configure them first.')
          return
        }
        
        if (!this.currentSelection) {
          this.showError('Please select a Frame or Component first')
          return
        }
        
        // Get form values
        const category = document.getElementById('category').value
        const priority = document.getElementById('priority').value
        const componentName = document.getElementById('componentName').value.trim()
        const requesterName = document.getElementById('requesterName').value.trim()
        const requesterEmail = document.getElementById('requesterEmail').value.trim()
        const description = document.getElementById('description').value.trim()
        
        // Validate required fields
        if (!category || !priority || !componentName || !requesterName || !requesterEmail || !description) {
          this.showError('Please fill in all required fields')
          return
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        if (!emailRegex.test(requesterEmail)) {
          this.showError('Please enter a valid email address')
          return
        }
        
        // Show loading state
        this.setLoadingState(true)
        
        // Send request to plugin code
        const requestData = {
          apiKey: this.apiSettings.key,
          apiEndpoint: this.apiSettings.endpoint,
          category,
          priority,
          componentName,
          requesterName,
          requesterEmail,
          description,
          selection: this.currentSelection,
          figmaLink: this.currentFigmaLink
        }
        
        this.sendToPlugin({ type: 'create-request', data: requestData })
      },

      clearForm() {
        document.getElementById('category').value = ''
        document.getElementById('priority').value = ''
        document.getElementById('componentName').value = ''
        document.getElementById('requesterName').value = ''
        document.getElementById('description').value = ''
        this.hideMessages()
        this.checkFormValidity()
      },

      setLoadingState(isLoading) {
        const actionButtons = document.getElementById('actionButtons')
        const loadingState = document.getElementById('loadingState')
        
        if (isLoading) {
          actionButtons.classList.add('hidden')
          loadingState.classList.remove('hidden')
        } else {
          actionButtons.classList.remove('hidden')
          loadingState.classList.add('hidden')
        }
      },

      resetLoadingState() {
        this.setLoadingState(false)
        this.checkFormValidity()
      }
    }

    // Global functions for onclick handlers
    function saveApiSettings() {
      pluginUI.saveApiSettings()
    }

    function createRequest() {
      pluginUI.createRequest()
    }

    function clearForm() {
      pluginUI.clearForm()
    }

    // Add event listeners for form validation
    document.addEventListener('DOMContentLoaded', function() {
      pluginUI.init()
      
      // Add input event listeners for form validation
      const inputs = document.querySelectorAll('input, textarea, select')
      inputs.forEach(input => {
        input.addEventListener('input', () => pluginUI.checkFormValidity())
      })
    })
  </script>
</body>
</html>
